# ---------- base ----------
FROM python:3.11-slim AS base

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

WORKDIR /app

RUN groupadd --gid 1000 appuser && \
    useradd --uid 1000 --gid 1000 --create-home --shell /bin/bash appuser

# ---------- builder ----------
FROM base AS builder

COPY pyproject.toml ./
COPY src/ ./src/

RUN pip install --prefix=/install .

# ---------- runtime ----------
FROM base AS runtime

COPY --from=builder /install /usr/local
COPY src/ ./src/

USER appuser

HEALTHCHECK --interval=30s --timeout=5s --start-period=15s --retries=3 \
    CMD ["python", "-c", "import subprocess, sys; r = subprocess.run(['celery', '-A', 'agentflow.worker', 'inspect', 'ping', '--timeout', '3'], capture_output=True); sys.exit(0 if r.returncode == 0 else 1)"]

CMD ["celery", "-A", "agentflow.worker", "worker", \
     "--loglevel=info", \
     "--concurrency=4", \
     "--max-tasks-per-child=100"]
